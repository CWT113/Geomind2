# 增删改操作



## 增加

获取到 `SqlSession` 对象后，需要注意默认是 **开启事务** 的，并且 **需要手动提交事务**，否则所以操作都会被回滚。

::: tip 提交事务的两种方式

- 手动提交

  ```java
  // 手动提交事务
  sqlSession.commit();
  ```

- 自动提交

  ```java
  // 设置 autoCommit 参数为 true，表示自动提交事务
  SqlSession sqlSession = sqlSessionFactory.openSession(true);
  ```

:::



::: code-group

```java [UserTest] {7,15}
@Test
public void testInsert() throws IOException {
  InputStream inputStream = Resources.getResourceAsStream("mybatis-config.xml");
  SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);

  // 开启自动事务提交
  SqlSession sqlSession = sqlSessionFactory.openSession(true);

  UserMapper mapper = sqlSession.getMapper(UserMapper.class);
  User user = new User("王一博886", "12345", "男", "甘肃省武威市");
  int affectRows = mapper.insert(user);
  System.out.println("affectRows = " + affectRows);

  // 手动提交事务
  // sqlSession.commit();

  sqlSession.close();
}
```

```java [UserMapper]
public interface UserMapper {
  int insert(User user);
}
```

```xml []
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.geomind.mapper.UserMapper">
  <insert id="insert">
    insert into tb_user (username, password, gender, addr)
    values (#{username}, #{password}, #{gender}, #{addr});
  </insert>
</mapper>
```

:::



### 主键返回

新增（插入）数据后获取数据库生成的主键值，需要使用 `useGeneratedKeys` 属性和 `keyProperty` 参数。

::: tip 提示

- `useGeneratedKeys="true"` 表示启用 JDBC 的 `getGeneratedKeys` 方法；
- `keyProperty="id"` 表示将返回的主键值设置到实体类的 id 属性上；

:::

::: code-group

```xml [UserMapper.xml] {6}
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.geomind.mapper.UserMapper">
  <insert id="insert" useGeneratedKeys="true" keyProperty="id">
    insert into tb_user (username, password, gender, addr)
    values (#{username}, #{password}, #{gender}, #{addr});
  </insert>
</mapper>
```

```java [UserTest] {15}
@Test
public void testInsert() throws IOException {
  InputStream inputStream = Resources.getResourceAsStream("mybatis-config.xml");
  SqlSessionFactory sqlSessionFactory 
    = new SqlSessionFactoryBuilder().build(inputStream);
  SqlSession sqlSession = sqlSessionFactory.openSession(true);
  
  UserMapper mapper = sqlSession.getMapper(UserMapper.class);

  User user = new User("王一博896", "12345", "男", "甘肃省武威市");
  int affectRows = mapper.insert(user);
  System.out.println("affectRows = " + affectRows);

  // 获取新增数据的主键Id
  Integer id = user.getId();
  System.out.println("id = " + id);

  sqlSession.close();
}
```

:::



## 修改

### 修改全部字段

::: code-group

```java [UserTest] {11}
@Test
public void testUpdate() throws IOException {
  InputStream inputStream = Resources.getResourceAsStream("mybatis-config.xml");
  SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
  SqlSession sqlSession = sqlSessionFactory.openSession(true);

  UserMapper mapper = sqlSession.getMapper(UserMapper.class);

  User user = new User("陈伟霆", "654321", "男", "中国香港");
  user.setId(1);
  int affectRows = mapper.update(user);
  System.out.println("affectRows = " + affectRows);

  sqlSession.close();
}
```

```java [UserMapper]
public interface UserMapper {
  int update(User user);
}
```

```xml [UserMapper.xml] {11}
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.geomind.mapper.UserMapper">
  <update id="update">
    update tb_user
    set username = #{username},
    		password = #{password},
    		gender   = #{gender},
    		addr     = #{addr} <!-- 注意末尾不要写 , 号 -->
    where id = #{id};
  </update>
</mapper>
```

:::

::: danger 注意

在 `UserMapper.xml` 中写 `update` 语句时，`set` 的最后一个字段后，不要携带 `,` 号。

:::



### 修改动态字段

::: code-group

```java [UserTest] {12}
@Test
public void testSingle() throws IOException {
  InputStream inputStream = Resources.getResourceAsStream("mybatis-config.xml");
  SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
  SqlSession sqlSession = sqlSessionFactory.openSession(true);

  UserMapper mapper = sqlSession.getMapper(UserMapper.class);

  User user = new User();
  user.setId(1);
  user.setUsername("彭于晏");
  int affectRows = mapper.updateSingle(user);
  System.out.println("affectRows = " + affectRows);

  sqlSession.close();
}
```

```java [UserMapper]
public interface UserMapper {
  int updateSingle(User user);
}
```

```xml [UserMapper.xml] {9,12,15,18}
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.geomind.mapper.UserMapper">
  <update id="updateSingle">
    update tb_user
    <set>
      <if test="username != null and username != ''">
        username = #{username},
      </if>
      <if test="password != null and password != ''">
        password = #{password},
      </if>
      <if test="gender != null and gender != ''">
        gender = #{gender},
      </if>
      <if test="addr != null and addr != ''">
        addr = #{addr}
      </if>
    </set>
    where id = #{id};
  </update>
</mapper>
```

:::



::: tip 解决 update 时，不传递任何字段值导致 SQL 执行报错问题

解决方案：

- 方式一：添加 id 字段作为保底更新字段；
- 方式二（推荐）：如果存在 `update_time` 等字段，可以默认更新时间字段；

```xml [UserMapper.xml] {21}
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.geomind.mapper.UserMapper">
  <update id="updateSingle">
    update tb_user
    <set>
      <if test="username != null and username != ''">
        username = #{username},
      </if>
      <if test="password != null and password != ''">
        password = #{password},
      </if>
      <if test="gender != null and gender != ''">
        gender = #{gender},
      </if>
      <if test="addr != null and addr != ''">
        addr = #{addr}
      </if>
      update_time = now()
    </set>
    where id = #{id};
  </update>
</mapper>
```

:::



## 删除

::: code-group

```java [UserTest] {9}
@Test
public void testDelete() throws IOException {
  InputStream inputStream = Resources.getResourceAsStream("mybatis-config.xml");
  SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
  SqlSession sqlSession = sqlSessionFactory.openSession(true);

  UserMapper mapper = sqlSession.getMapper(UserMapper.class);

  int affectRows = mapper.deleteById(1);
  System.out.println("affectRows = " + affectRows);

  sqlSession.close();
}
```

```java [UserMapper]
public interface UserMapper {
  int deleteById(Integer id);
}
```

```xml [UserMapper.xml]
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.geomind.mapper.UserMapper">
  <delete id="deleteById">
    delete
    from tb_user
    where id = #{id};
  </delete>
</mapper>
```

:::
